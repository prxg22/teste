name: develop CI/CD
on:
  pull_request:
    branches:
      - master

jobs:
  continous-integration:
    name: CI
    runs-on: [ubuntu-latest]
    env:
      GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      PERSONAL_GITHUB_TOKEN: ${{secrets.PERSONAL_GITHUB_TOKEN}}

    steps:
      - uses: actions/checkout@v1.2.0
      - uses: actions/setup-node@master
        with:
          node-version: 12.x
      - run: ./node_modules/.bin/lerna bootstrap
      - name: lint
        run: ./node_modules/.bin/lerna run lint
      - name: tests
        run: ./node_modules/.bin/lerna run test -- --coverage
      - name: fix code coverage paths
        # https://community.sonarsource.com/t/code-coverage-doesnt-work-with-github-action/16747/5
        run: |
          REPO_NAME="$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)"
          sed -i "s/\/home\/runner\/work\/$REPO_NAME\/$REPO_NAME\//\/github\/workspace\//g" coverage/lcov.info
          sed -i "s/\/home\/runner\/work\/$REPO_NAME\/$REPO_NAME\//\/github\/workspace\//g" test-report.xml
      - name: analyze on SonarCloud
        # change to oficial lib when accepts pull_request events
        # https://github.com/SonarSource/sonarcloud-github-action/pull/6
        # uses: sonarsource/sonarcloud-github-action@master
        uses: lemonenergy/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  release:
    name: Relase
    runs-on: [ubuntu-latest]
    needs: [continous-integration]
    env:
      GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      PERSONAL_GITHUB_TOKEN: ${{secrets.PERSONAL_GITHUB_TOKEN}}

    steps:
      - uses: actions/checkout@v1.2.0
      - uses: actions/setup-node@master
        with:
          node-version: 12.x
      - run: ./node_modules/.bin/lerna version
